# Repo settings must allow:
# - allow both squash merges (for ticket PRs) and merge commits (for mainâ†’develop).
# - enable auto-merge (repo settings).
name: Auto-squash PRs into develop
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited, labeled, unlabeled]
    branches: [ develop ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto_squash: # Do not auto-squash PRs from main or sync/* branches
    if: >
      github.event.pull_request.base.ref == 'develop' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.ref != 'main' &&
      !startsWith(github.event.pull_request.head.ref, 'sync/')
    runs-on: ubuntu-latest
    steps:
      - name: Arm auto-merge (squash) after mergeability is known
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          # wait for GitHub to compute mergeability to avoid "UNSTABLE/UNKNOWN"
          for i in {1..24}; do
            state=$(gh pr view "$PR" --repo "$REPO" --json mergeStateStatus --jq .mergeStateStatus)
            echo "mergeStateStatus=$state"
            [[ "$state" =~ ^(UNKNOWN|UNSTABLE)$ ]] && sleep 5 || break
          done
          # arm squash auto-merge; it will complete once required checks/approvals pass
          gh pr merge "$PR" --repo "$REPO" --squash --auto || {
            echo "Retrying arm after short wait..."
            sleep 10
            gh pr merge "$PR" --repo "$REPO" --squash --auto
          }
