# ==============================
# Sync main branch to develop branch
# On push to main, create/update PR to develop
# Auto-merge PR with merge commit
# ==============================

name: Sync main to develop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

# Only one sync job at a time; cancel in-progress on new pushes
concurrency:
  group: sync-main-to-develop
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute sync metadata
        id: syncmeta
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          SYNC_BRANCH='sync/main-to-develop'

          # Short SHA (12 chars) for traceability
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            git fetch --quiet origin main
            SHORT_SHA="$(git rev-parse --short=12 origin/main)"
          else
            SHORT_SHA="${GITHUB_SHA:0:12}"
          fi

          echo "SYNC_BRANCH=${SYNC_BRANCH}" >> "${GITHUB_OUTPUT}"
          echo "SHORT_SHA=${SHORT_SHA}"     >> "${GITHUB_OUTPUT}"

      - name: Create or refresh sync branch from main (force-update)
        env:
          SYNC_BRANCH: ${{ steps.syncmeta.outputs.SYNC_BRANCH }}
        run: |
          set -euo pipefail
          git fetch --quiet origin main
          git checkout -B "${SYNC_BRANCH}" origin/main
          git push -u -f origin "${SYNC_BRANCH}"

      - name: Open or reuse PR main to develop with description
        env:
          SYNC_BRANCH: ${{ steps.syncmeta.outputs.SYNC_BRANCH }}
          SHORT_SHA:   ${{ steps.syncmeta.outputs.SHORT_SHA }}
          GH_TOKEN:    ${{ secrets.GITHUB_TOKEN }}
          REPO:        ${{ github.repository }}
          BEFORE:      ${{ github.event.before }}   # empty for workflow_dispatch
          AFTER:       ${{ github.sha }}            # the pushed SHA
        run: |
          set -euo pipefail

          body_file="${RUNNER_TEMP}/sync_pr_body.md"
          repo_url="https://github.com/${REPO}"
          : > "${body_file}"

          echo "Automated PR to sync **main** into **develop**." >> "${body_file}"
          echo "" >> "${body_file}"

          if [ -n "${AFTER:-}" ]; then
            short_after="${AFTER:0:12}"
            echo "Latest on \`main\`: **${short_after}**" >> "${body_file}"
            echo "- Commit: ${repo_url}/commit/${AFTER}" >> "${body_file}"
            # Single-commit title (for manual runs or just for context)
            title="$(gh api "repos/${REPO}/commits/${AFTER}" --jq '.commit.message | split("\n")[0]' || true)"
            if [ -n "${title}" ]; then
              echo "- Title: ${title}" >> "${body_file}"
            fi
          fi

          if [ -n "${BEFORE:-}" ] && [ -n "${AFTER:-}" ]; then
            echo "- Compare: ${repo_url}/compare/${BEFORE}...${AFTER}" >> "${body_file}"
            echo "" >> "${body_file}"
            echo "Commits in this sync:" >> "${body_file}"
            # Up to 50 commits, each as: "- 6b3ca69: Commit subject"
            gh api "repos/${REPO}/compare/${BEFORE}...${AFTER}" \
              --jq '.commits[0:50][] | "- \(.sha[0:7]): \(.commit.message | split("\n")[0])"' \
              -q -r >> "${body_file}" || true
          fi

          existing="$(gh pr list --repo "${REPO}" --base develop --head "${SYNC_BRANCH}" --state open --json number --jq '.[0].number // empty')"

          if [ -z "${existing}" ]; then
            gh pr create \
              --repo  "${REPO}" \
              --base  develop \
              --head  "${SYNC_BRANCH}" \
              --title "Sync main -> develop (${SHORT_SHA})" \
              --body-file "${body_file}"
            PR_NUMBER="$(gh pr list --repo "${REPO}" --base develop --head "${SYNC_BRANCH}" --state open --json number --jq '.[0].number')"
          else
            PR_NUMBER="${existing}"
            gh pr edit "${PR_NUMBER}" --repo "${REPO}" \
              --title "Sync main -> develop (${SHORT_SHA})" \
              --body-file "${body_file}"
          fi

          echo "PR_NUMBER=${PR_NUMBER}" >> "${GITHUB_ENV}"

      - name: Wait for mergeability to be confirmed (avoid UNSTABLE/UNKNOWN flakey states)
        if: env.PR_NUMBER != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          for i in {1..24}; do
            state=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergeStateStatus --jq .mergeStateStatus)
            echo "mergeStateStatus=$state"
            [[ "$state" =~ ^(UNKNOWN|UNSTABLE)$ ]] && sleep 5 || break
          done

      - name: Enable auto-merge (merge commit) with retry
        if: env.PR_NUMBER != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          for i in {1..6}; do
            if gh pr merge "$PR_NUMBER" --repo "$REPO" --merge --auto; then
              echo "Auto-merge enabled (merge commit)."
              exit 0
            fi
            echo "Auto-merge not enableable yet (attempt $i); retrying in 10s..."
            sleep 10
          done
          echo "::error::Failed to enable auto-merge after retries."
          exit 1
